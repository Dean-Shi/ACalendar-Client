/*!
 * rrule.js - Library for working with recurrence rules for calendar dates.
 * https://github.com/jkbr/rrule
 *
 * Copyright 2010, Jakub Roztocil and Lars Schoning
 * Licenced under the BSD licence.
 * https://github.com/jkbr/rrule/blob/master/LICENCE
 *
 */

(function(e){var t=typeof module!="undefined"&&module.exports,n,r;if(t)n=require("underscore"),r=require("./rrule").RRule;else if(e.RRule||e._)r=e.RRule,n=e._;else{if(typeof require=="undefined")throw"rrule.js and underscore.js are required for rrule/nlp.js to work";r||(r=require("rrule")),!n&&typeof require!="undefined"&&(n=require("underscore"))}var i=function(e,t,r){this.gettext=t||function(e){return e},this.language=r||f,this.text="",this.rrule=e,this.freq=e.options.freq,this.options=e.options,this.origOptions=e.origOptions;if(this.origOptions.bymonthday){var i=[].concat(this.options.bymonthday),s=[].concat(this.options.bynmonthday);i.sort(),s.sort(),s.reverse(),this.bymonthday=i.concat(s),this.bymonthday.length||(this.bymonthday=null)}if(this.origOptions.byweekday){var o=this.origOptions.byweekday instanceof Array?this.origOptions.byweekday:[this.origOptions.byweekday],u=String(o);this.byweekday={allWeeks:n.filter(o,function(e){return!Boolean(e.n)}),someWeeks:n.filter(o,function(e){return Boolean(e.n)}),isWeekdays:u.indexOf("MO")!=-1&&u.indexOf("TU")!=-1&&u.indexOf("WE")!=-1&&u.indexOf("TH")!=-1&&u.indexOf("FR")!=-1&&u.indexOf("SA")==-1&&u.indexOf("SU")==-1};var a=function(e,t){return e.weekday-t.weekday};this.byweekday.allWeeks.sort(a),this.byweekday.someWeeks.sort(a),this.byweekday.allWeeks.length||(this.byweekday.allWeeks=null),this.byweekday.someWeeks.length||(this.byweekday.someWeeks=null)}else this.byweekday=null};i.IMPLEMENTED=[];var s=["count","until","interval","byweekday","bymonthday","bymonth"];i.IMPLEMENTED[r.DAILY]=s,i.IMPLEMENTED[r.WEEKLY]=s,i.IMPLEMENTED[r.MONTHLY]=s,i.IMPLEMENTED[r.YEARLY]=["byweekno","byyearday"].concat(s),i.isFullyConvertible=function(e){var t=!0;return e.options.freq in i.IMPLEMENTED?e.origOptions.until&&e.origOptions.count?!1:(n.each(e.origOptions,function(r,s){if(n.contains(["dtstart","wkst","freq"],s))return!0;if(!n.include(i.IMPLEMENTED[e.options.freq],s))return t=!1,!1}),t):!1},i.prototype={isFullyConvertible:function(){return i.isFullyConvertible(this.rrule)},toString:function(){var e=this.gettext;if(this.options.freq in i.IMPLEMENTED){this.text=[e("every")],this[r.FREQUENCIES[this.options.freq]]();if(this.options.until){this.add(e("until"));var t=this.options.until;this.add(this.language.monthNames[t.getMonth()]).add(t.getDate()+",").add(t.getFullYear())}else this.options.count&&this.add(e("for")).add(this.options.count).add(this.plural(this.options.count)?e("times"):e("time"));return this.isFullyConvertible()||this.add(e("(~ approximate)")),this.text.join("")}return e("RRule error: Unable to fully convert this rrule to text")},DAILY:function(){var e=this.gettext;this.options.interval!=1&&this.add(this.options.interval),this.byweekday&&this.byweekday.isWeekdays?this.add(this.plural(this.options.interval)?e("weekdays"):e("weekday")):this.add(this.plural(this.options.interval)?e("days"):e("day")),this.origOptions.bymonth&&(this.add(e("in")),this._bymonth()),this.bymonthday?this._bymonthday():this.byweekday&&this._byweekday()},WEEKLY:function(){var e=this.gettext;this.options.interval!=1&&this.add(this.options.interval).add(this.plural(this.options.interval)?e("weeks"):e("week")),this.byweekday&&this.byweekday.isWeekdays?this.options.interval==1?this.add(this.plural(this.options.interval)?e("weekdays"):e("weekday")):this.add(e("ON")).add(e("weekdays")):(this.options.interval==1&&this.add(e("week")),this.origOptions.bymonth&&(this.add(e("in")),this._bymonth()),this.bymonthday?this._bymonthday():this.byweekday&&this._byweekday())},MONTHLY:function(){var e=this.gettext;this.origOptions.bymonth?(this.options.interval!=1&&(this.add(this.options.interval).add(e("months")),this.plural(this.options.interval)&&this.add(e("in"))),this._bymonth()):(this.options.interval!=1&&this.add(this.options.interval),this.add(this.plural(this.options.interval)?e("months"):e("month"))),this.bymonthday?this._bymonthday():this.byweekday&&this._byweekday()},YEARLY:function(){var e=this.gettext;this.origOptions.bymonth?(this.options.interval!=1&&(this.add(this.options.interval),this.add(e("years"))),this._bymonth()):(this.options.interval!=1&&this.add(this.options.interval),this.add(this.plural(this.options.interval)?e("years"):e("year"))),this.bymonthday?this._bymonthday():this.byweekday&&this._byweekday(),this.options.byyearday&&this.add(e("on the")).add(this.list(this.options.byyearday,this.nth,e("and"))).add(e("day")),this.options.byweekno&&this.add(e("in")).add(this.plural(this.options.byweekno.length)?e("weeks"):e("week")).add(this.list(this.options.byweekno,null,e("and")))},_bymonthday:function(){var e=this.gettext;this.byweekday&&this.byweekday.allWeeks?this.add(e("on")).add(this.list(this.byweekday.allWeeks,this.weekdaytext,e("or"))).add(e("the")).add(this.list(this.bymonthday,this.nth,e("or"))):this.add(e("on the")).add(this.list(this.bymonthday,this.nth,e("and")))},_byweekday:function(){var e=this.gettext;this.byweekday.allWeeks&&!this.byweekday.isWeekdays&&this.add(e("on")).add(this.list(this.byweekday.allWeeks,this.weekdaytext)),this.byweekday.someWeeks&&(this.byweekday.allWeeks&&this.add(e("and")),this.add(e("on the")).add(this.list(this.byweekday.someWeeks,this.weekdaytext,e("and"))))},_bymonth:function(){this.add(this.list(this.options.bymonth,this.monthtext,this.gettext("and")))},nth:function(e){var t,n,r=this.gettext;if(e==-1)return r("last");n=Math.abs(e);switch(n){case 1:case 21:case 31:t=n+r("st");break;case 2:case 22:t=n+r("nd");break;case 3:case 23:t=n+r("rd");break;default:t=n+r("th")}return e<0?t+" "+r("last"):t},monthtext:function(e){return this.language.monthNames[e-1]},weekdaytext:function(e){return(e.n?this.nth(e.n)+" ":"")+this.language.dayNames[e.getJsWeekday()]},plural:function(e){return e%100!=1},add:function(e){return this.text.push(" "),this.text.push(e),this},list:function(e,t,r,i){var s=function(e,t,n){var r="";for(var i=0;i<e.length;i++)i!=0&&(i==e.length-1?r+=" "+n+" ":r+=t+" "),r+=e[i];return r};i=i||",",t=t||function(e){return e};var o=this,u=function(e){return t.call(o,e)};return r?s(n.map(e,u),i,r):n.map(e,u).join(i+" ")}};var o=function(e,t){return new r(u(e,t))},u=function(e,t){function s(){n.expect("every");var e;if(e=n.accept("number"))i.interval=parseInt(e[0]);if(n.isDone())throw"Unexpected end";switch(n.symbol){case"day(s)":i.freq=r.DAILY,n.nextSymbol()&&(o(),p());break;case"weekday(s)":i.freq=r.WEEKLY,i.byweekday=[r.MO,r.TU,r.WE,r.TH,r.FR],n.nextSymbol(),p();break;case"week(s)":i.freq=r.WEEKLY,n.nextSymbol()&&(o(),p());break;case"month(s)":i.freq=r.MONTHLY,n.nextSymbol()&&(o(),p());break;case"year(s)":i.freq=r.YEARLY,n.nextSymbol()&&(o(),p());break;case"monday":case"tuesday":case"wednesday":case"thursday":case"friday":case"saturday":case"sunday":i.freq=r.WEEKLY,i.byweekday=[r[n.symbol.substr(0,2).toUpperCase()]];if(!n.nextSymbol())return;while(n.accept("comma")){if(n.isDone())throw"Unexpected end";var t;if(!(t=l()))throw"Unexpected symbol "+n.symbol+", expected weekday";i.byweekday.push(r[t]),n.nextSymbol()}h(),p();break;case"january":case"february":case"march":case"april":case"may":case"june":case"july":case"august":case"september":case"october":case"november":case"december":i.freq=r.YEARLY,i.bymonth=[u()];if(!n.nextSymbol())return;while(n.accept("comma")){if(n.isDone())throw"Unexpected end";var s;if(!(s=u()))throw"Unexpected symbol "+n.symbol+", expected month";i.bymonth.push(s),n.nextSymbol()}o(),p();break;default:throw"Unknown symbol"}}function o(){var e=n.accept("on"),t=n.accept("the");if(!e&&!t)return;do{var s,o,a;if(s=c())(o=l())?(n.nextSymbol(),i.byweekday||(i.byweekday=[]),i.byweekday.push(r[o].nth(s))):(i.bymonthday||(i.bymonthday=[]),i.bymonthday.push(s),n.accept("day(s)"));else if(o=l())n.nextSymbol(),i.byweekday||(i.byweekday=[]),i.byweekday.push(r[o]);else if(n.symbol=="weekday(s)")n.nextSymbol(),i.byweekday||(i.byweekday=[]),i.byweekday.push(r.MO),i.byweekday.push(r.TU),i.byweekday.push(r.WE),i.byweekday.push(r.TH),i.byweekday.push(r.FR);else if(n.symbol=="week(s)"){n.nextSymbol();var f;if(!(f=n.accept("number")))throw"Unexpected symbol "+n.symbol+", expected week number";i.byweekno=[f[0]];while(n.accept("comma")){if(!(f=n.accept("number")))throw"Unexpected symbol "+n.symbol+"; expected monthday";i.byweekno.push(f[0])}}else{if(!(a=u()))return;n.nextSymbol(),i.bymonth||(i.bymonth=[]),i.bymonth.push(a)}}while(n.accept("comma")||n.accept("the")||n.accept("on"))}function u(){switch(n.symbol){case"january":return 1;case"february":return 2;case"march":return 3;case"april":return 4;case"may":return 5;case"june":return 6;case"july":return 7;case"august":return 8;case"september":return 9;case"october":return 10;case"november":return 11;case"december":return 12;default:return!1}}function l(){switch(n.symbol){case"monday":case"tuesday":case"wednesday":case"thursday":case"friday":case"saturday":case"sunday":return n.symbol.substr(0,2).toUpperCase();default:return!1}}function c(){switch(n.symbol){case"last":return n.nextSymbol(),-1;case"first":return n.nextSymbol(),1;case"second":return n.nextSymbol(),n.accept("last")?-2:2;case"third":return n.nextSymbol(),n.accept("last")?-3:3;case"nth":var e=parseInt(n.value[1]);if(e<-366||e>366)throw"Nth out of range: "+e;return n.nextSymbol(),n.accept("last")?-e:e;default:return!1}}function h(){n.accept("on"),n.accept("the");var e;if(!(e=c()))return;i.bymonthday=[e],n.nextSymbol();while(n.accept("comma")){if(!(e=c()))throw"Unexpected symbol "+n.symbol+"; expected monthday";i.bymonthday.push(e),n.nextSymbol()}}function p(){if(n.symbol=="until"){var e=Date.parse(n.text);if(!e)throw"Cannot parse until date:"+n.text;i.until=new Date(e)}else n.accept("for")&&(i.count=n.value[0],n.expect("number"))}var n=new a((t||f).tokens);if(!n.start(e))return null;var i={};return s(),i},a=function(e){this.rules=e};a.prototype.start=function(e){return this.text=e,this.done=!1,this.nextSymbol()},a.prototype.isDone=function(){return this.done&&this.symbol==null},a.prototype.nextSymbol=function(){var e=this,t,r;this.symbol=null,this.value=null;do{if(this.done)return!1;t=null,n.each(this.rules,function(n,i){var s;if(s=n.exec(e.text))if(t==null||s[0].length>t[0].length)t=s,r=i}),t!=null&&(this.text=this.text.substr(t[0].length),this.text==""&&(this.done=!0));if(t==null){this.done=!0,this.symbol=null,this.value=null;return}}while(r=="SKIP");return this.symbol=r,this.value=t,!0},a.prototype.accept=function(e){if(this.symbol==e){if(this.value){var t=this.value;return this.nextSymbol(),t}return this.nextSymbol(),!0}return!1},a.prototype.expect=function(e){if(this.accept(e))return!0;throw"expected "+e+" but found "+this.symbol};var f={dayNames:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],monthNames:["January","February","March","April","May","June","July","August","September","October","November","December"],tokens:{SKIP:/^[ \r\n\t]+|^\.$/,number:/^[1-9][0-9]*/,numberAsText:/^(one|two|three)/i,every:/^every/i,"day(s)":/^days?/i,"weekday(s)":/^weekdays?/i,"week(s)":/^weeks?/i,"month(s)":/^months?/i,"year(s)":/^years?/i,on:/^(on|in)/i,the:/^the/i,first:/^first/i,second:/^second/i,third:/^third/i,nth:/^([1-9][0-9]*)(\.|th|nd|rd|st)/i,last:/^last/i,"for":/^for/i,"time(s)":/^times?/i,until:/^(un)?til/i,monday:/^mo(n(day)?)?/i,tuesday:/^tu(e(s(day)?)?)?/i,wednesday:/^we(d(n(esday)?)?)?/i,thursday:/^th(u(r(sday)?)?)?/i,friday:/^fr(i(day)?)?/i,saturday:/^sa(t(urday)?)?/i,sunday:/^su(n(day)?)?/i,january:/^jan(uary)?/i,february:/^feb(ruary)?/i,march:/^mar(ch)?/i,april:/^apr(il)?/i,may:/^may/i,june:/^june?/i,july:/^july?/i,august:/^aug(ust)?/i,september:/^sep(t(ember)?)?/i,october:/^oct(ober)?/i,november:/^nov(ember)?/i,december:/^dec(ember)?/i,comma:/^(,\s*|(and|or)\s*)+/i}},l={fromText:o,parseText:u,isFullyConvertible:i.isFullyConvertible,toText:function(e,t,n){return(new i(e,t,n)).toString()}};t?module.exports=l:e._RRuleNLP=l,typeof define=="function"&&define.amd&&define("rrule",[],function(){return r})})(this);
//     keymaster.js
//     (c) 2011-2012 Thomas Fuchs
//     keymaster.js may be freely distributed under the MIT license.

(function(e){function t(e,t){var n=e.length;while(n--)if(e[n]===t)return n;return-1}function n(e,t){if(e.length!=t.length)return!1;for(var n=0;n<e.length;n++)if(e[n]!==t[n])return!1;return!0}function r(e){for(b in E)E[b]=e[k[b]]}function i(e,n){var i,s,o,a,f;i=e.keyCode,t(C,i)==-1&&C.push(i);if(i==93||i==224)i=91;if(i in E){E[i]=!0;for(o in x)x[o]==i&&(u[o]=!0);return}r(e);if(!u.filter.call(this,e))return;if(!(i in w))return;for(a=0;a<w[i].length;a++){s=w[i][a];if(s.scope==n||s.scope=="all"){f=s.mods.length>0;for(o in E)if(!E[o]&&t(s.mods,+o)>-1||E[o]&&t(s.mods,+o)==-1)f=!1;(s.mods.length==0&&!E[16]&&!E[18]&&!E[17]&&!E[91]||f)&&s.method(e,s)===!1&&(e.preventDefault?e.preventDefault():e.returnValue=!1,e.stopPropagation&&e.stopPropagation(),e.cancelBubble&&(e.cancelBubble=!0))}}}function s(e){var n=e.keyCode,r,i=t(C,n);i>=0&&C.splice(i,1);if(n==93||n==224)n=91;if(n in E){E[n]=!1;for(r in x)x[r]==n&&(u[r]=!1)}}function o(){for(b in E)E[b]=!1;for(b in x)u[b]=!1}function u(e,t,n){var r,i,s,o;r=v(e),n===undefined&&(n=t,t="all");for(s=0;s<r.length;s++)i=[],e=r[s].split("+"),e.length>1&&(i=m(e),e=[e[e.length-1]]),e=e[0],e=N(e),e in w||(w[e]=[]),w[e].push({shortcut:r[s],scope:t,method:n,key:r[s],mods:i})}function a(e,t){var r=e.split("+"),i=[],s,o;r.length>1&&(i=m(r),e=r[r.length-1]),e=N(e),t===undefined&&(t=p());if(!w[e])return;for(s in w[e])o=w[e][s],o.scope===t&&n(o.mods,i)&&(w[e][s]={})}function f(e){return typeof e=="string"&&(e=N(e)),t(C,e)!=-1}function l(){return C.slice(0)}function c(e){var t=(e.target||e.srcElement).tagName;return t!="INPUT"&&t!="SELECT"&&t!="TEXTAREA"}function h(e){S=e||"all"}function p(){return S||"all"}function d(e){var t,n,r;for(t in w){n=w[t];for(r=0;r<n.length;)n[r].scope===e?n.splice(r,1):r++}}function v(e){var t;return e=e.replace(/\s/g,""),t=e.split(","),t[t.length-1]==""&&(t[t.length-2]+=","),t}function m(e){var t=e.slice(0,e.length-1);for(mi=0;mi<t.length;mi++)t[mi]=x[t[mi]];return t}function g(e,t,n){e.addEventListener?e.addEventListener(t,n,!1):e.attachEvent&&e.attachEvent("on"+t,function(){n(window.event)})}function y(){var t=e.key;return e.key=L,t}var b,w={},E={16:!1,18:!1,17:!1,91:!1},S="all",x={"⇧":16,shift:16,"⌥":18,alt:18,option:18,"⌃":17,ctrl:17,control:17,"⌘":91,command:91},T={backspace:8,tab:9,clear:12,enter:13,"return":13,esc:27,escape:27,space:32,left:37,up:38,right:39,down:40,del:46,"delete":46,home:36,end:35,pageup:33,pagedown:34,",":188,".":190,"/":191,"`":192,"-":189,"=":187,";":186,"'":222,"[":219,"]":221,"\\":220},N=function(e){return T[e]||e.toUpperCase().charCodeAt(0)},C=[];for(b=1;b<20;b++)T["f"+b]=111+b;var k={16:"shiftKey",18:"altKey",17:"ctrlKey",91:"metaKey"};for(b in x)u[b]=!1;g(document,"keydown",function(e){i(e,S)}),g(document,"keyup",s),g(window,"focus",o);var L=e.key;e.key=u,e.key.setScope=h,e.key.getScope=p,e.key.deleteScope=d,e.key.filter=c,e.key.isPressed=f,e.key.getPressedKeyCodes=l,e.key.noConflict=y,e.key.unbind=a,typeof module!="undefined"&&(module.exports=key)})(this);
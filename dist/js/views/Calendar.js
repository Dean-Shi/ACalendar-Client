define(["jquery","underscore","backbone","rrule","views/EventEditor","models/Event","collections/Events","modules/Backbone.sync","fullCalendar","bootstrap","jqueryui","qtip"],function(e,t,n,r,i,s,o){var u=n.View.extend({initialize:function(){var t=this;this.$el=e("<div/>").qtip({id:"tooltip",prerender:!0,content:{text:"",title:"New Event",button:"Close"},position:{my:"bottom center",at:"top center",viewport:e(window),target:"event"},events:{render:function(t,n){e(window).on("keydown",function(e){e.keyCode===27&&n.hide(e)})},hide:function(e,n){n.elements.tooltip.stop(1,1),t.calendarView.$el.fullCalendar("unselect")}},hide:!1,style:"qtip-bootstrap"}).qtip("api")},render:function(e){this.$el.elements.tooltip.stop(1,1),this.$el.reposition(e).toggle(!0,e)},set:function(e,t,n,r){this.start=e,this.end=t,this.allDay=n,this.$el.set({"content.text":r})},isBlank:function(e){return/^\s*$/.test(e)},hide:function(){this.$el.toggle(!1)},generateId:function(){return(new Date).getTime().toString()},listener:function(){function a(){var e=r.val();if(t.isBlank(e)){alert("Event title cannot be an empty or blank string.");return}var n={_id:t.generateId(),title:e,allDay:t.allDay,start:t.start,end:t.end,rrule:null,last_modified:new Date};t.collection.create(new s(n),{success:t.hide()}),console.log(t.collection.toJSON())}var t=this,n=e("#qtip-tooltip"),r=n.find("#tooltip-title-input").focus(),i=n.find("#tooltip-create-event"),o=n.find("#tooltip-cancel"),u=n.find("#advanced-edit");i.on("click",a),r.on("keydown",function(e){e.keyCode===13&&a()}),u.on("click",function(){var e={_id:null,title:r.val(),allDay:t.allDay,start:t.start,end:t.end,rrule:null,last_modified:null};t.calendarView.hideView(),t.eventEditorView.model=new s(e),t.eventEditorView.render(),t.hide()}),o.on("click",function(){t.hide()})}});return n.View.extend({el:"#calendar",initialize:function(){t.bindAll(this,"select","unselect","loading","eventRender","eventDragStart","eventResizeStart","eventDrop","eventResize","eventClick"),this.eventResizing=!1,this.elementArray=[],this.tooltip=new u,this.eventEditorView=new i,this.render()},render:function(){this.onloading={pleaseWaitDiv:e("#pleaseWaitDialog"),showPleaseWait:function(){this.pleaseWaitDiv.modal("show")},hidePleaseWait:function(){this.pleaseWaitDiv.modal("hide")}},this.$el.fullCalendar({header:{left:"prev,next today title",right:"month,agendaWeek,agendaDay"},height:e(window).height()-80,timeFormat:"h:mmtt{ - h:mmtt}",editable:!0,selectable:!0,selectHelper:!0,select:this.select,slotMinutes:15,unselect:this.unselect,unselectCancel:".qtip",loading:this.loading,eventResizeStart:this.eventResizeStart,eventDragStart:this.eventDragStart,eventClick:this.eventClick,eventDrop:this.eventDrop,eventResize:this.eventResize,eventRender:this.eventRender,eventAfterAllRender:this.eventAfterAllRender}),this.tooltip.collection=this.eventEditorView.collection=this.collection,this.tooltip.calendarView=this.eventEditorView.calendarView=this,this.tooltip.eventEditorView=this.eventEditorView;var t=this;this.collection.fetch({success:function(e){console.log(e.toJSON()),t.listenTo(t.collection,"add change update destroy",function(){t.$el.fullCalendar("refetchEvents")}),t.renderEvents()}}),this.on("show",this.showView),e(window).on("resize",function(){if(t.eventResizing)return;t.resizeCalendar(),t.destroyQtip(),t.$el.fullCalendar("rerenderEvents")})},showView:function(){this.$el.show(),this.resizeCalendar()},hideView:function(){this.$el.hide()},resizeCalendar:function(){this.$el.fullCalendar("option","height",e(window).height()-80)},renderEvents:function(){var e=this,n={events:function(n,i,s){var o=[],u=[];e.collection.filter(function(e){e.get("rrule")==null?o.push(e.toJSON()):u.push(e.toJSON())});for(var a=u.length-1;a>=0;a--){var f=u[a],l=new r(f.rrule),c=l.between(n,i,!0),h=f.end?f.end.getTime()-f.start.getTime():0;for(var p=c.length-1;p>=0;p--){var d=t.clone(f);d.start=c[p],d.end=new Date(d.start.getTime()+h),e.$el.fullCalendar("renderEvent",d)}}s(o)},color:"",textColor:""};this.$el.fullCalendar("addEventSource",n)},select:function(e,t,n,r){var i=this,s=this.popover(e,t,n,null,!0);this.tooltip.set(e,t,n,s),this.tooltip.render(r),this.tooltip.listener()},unselect:function(){this.hideTooltip()},loading:function(e){e?this.onloading.showPleaseWait():this.onloading.hidePleaseWait()},eventClick:function(e){},eventDrop:function(e,t,n,r,i){this.eventDropOrResize(e,i)},eventResize:function(e,t,n,r){this.eventDropOrResize(e,r),this.eventResizing=!1},eventDropOrResize:function(e,n){var r=this.collection.get(e._id),i=r.get("rrule");t.isNull(i)||(i.dtstart=e.start),this.collection.get(e._id).save({start:e.start,end:e.end,rrule:i})},eventResizeStart:function(e){this.hideQtip(e),this.eventResizing=!0},eventDragStart:function(e){this.hideQtip(e)},popover:function(t,n,r,i,s){var o=new Date(t),u=new Date(n),a="ddd, MMMM d",f="",l="";if(n&&(!r||o.getDate()!=u.getDate())){f=" - ";if(o.getFullYear()!=u.getFullYear())f+=a+=", yyyy";else if(o.getDate()!=u.getDate()||o.getMonth()!=u.getMonth())f+=a}return r||(a+=", h(:mm)tt",f+="h(:mm)tt"),o=e.fullCalendar.formatDate(o,a),u=e.fullCalendar.formatDate(u,f),s?l='<table><tbody><tr><th>Date:  </th><td id="tooltip-date">'+o+u+"</td>"+"</tr>"+"<tr>"+"<th>Title: </th>"+'<td><input id="tooltip-title-input" type="text" class="form-control"></td>'+"</tr>"+"<tr>"+'<td colspan="2">'+'<button id="tooltip-create-event" type="button" class="btn btn-xs btn-primary">Create</button>'+'<button id="tooltip-cancel" type="button" class="btn btn-xs btn-default">Cancel</button>'+'<a href="javascript:void(0)" id="advanced-edit">Advanced Edit</a>'+"</td>"+"</tr>"+"</tbody>"+"</table>":l="<h3>"+i+"</h3>"+"<p><b>Date:</b> "+o+(n&&u+"</p>"||""),l},eventRender:function(n,r){var i=this.popover(n.start,n.end,n.allDay,n.title,!1),s=n._id+(n.rrule?"-"+n.start.getTime():"");t.isUndefined(this.elementArray[s])||this.elementArray[s].destroy(!0);var o=this,u=r.qtip({id:s,content:{title:n.title+'<div class="pull-right"><a class="qtip-edit" title="Edit" aria-label="Edit" role="button"><span class="glyphicon glyphicon-edit"></span></a><a class="qtip-delete" title="Delete" aria-label="Delete" role="button" style="margin-left: 5px"><span class="glyphicon glyphicon-trash"></span></a></div>',text:i},position:{my:"bottom center",at:"top center",viewport:e(window)},events:{render:function(t,n){var r=n.id.replace(/-.*/,"");e(this).on("click",".qtip-edit",function(){n.toggle(!1),o.hideView(),o.tooltip.hide(),o.eventEditorView.model=o.collection.get(r),o.eventEditorView.render()}),e(this).on("click",".qtip-delete",function(){confirm("Are you sure you want to delete this event?")&&o.collection.get(r).destroy({success:n.destroy(!0)})})}},hide:{fixed:!0,delay:300},style:"qtip-bootstrap"}).qtip("api");this.elementArray[s]=u},eventAfterAllRender:function(){console.log("all render")},hideTooltip:function(){this.tooltip.hide()},hideQtip:function(t){e("#qtip-"+t._id).qtip().hide()},destroyQtip:function(){var e;while(e=this.elementArray.pop())e.destroy(!0)}})});
define(["jquery","underscore","backbone","rrule","views/EventEditor","models/Event","collections/Events","moment","modules/Backbone.sync","fullCalendar","bootstrap","jqueryui","qtip","datepicker","shortcuts"],function(e,t,n,r,i,s,o,u){var a=n.View.extend({initialize:function(){var t=this;this.$el=e("<div/>").qtip({id:"tooltip",prerender:!0,content:{text:"",title:"New Event",button:"Close"},position:{my:"bottom center",at:"top center",viewport:e(window),target:"event"},events:{render:function(t,n){e(window).on("keydown",function(e){e.keyCode===27&&n.hide(e)})},hide:function(e,n){n.elements.tooltip.stop(1,1),t.calendarView.$el.fullCalendar("unselect")}},hide:!1,style:"qtip-bootstrap"}).qtip("api")},render:function(e){this.$el.elements.tooltip.stop(1,1),this.$el.reposition(e).toggle(!0,e),this.listener()},set:function(e,t,n,r){this.start=e,this.end=t,this.allDay=n,this.$el.set({"content.text":r})},isBlank:function(e){return/^\s*$/.test(e)},hide:function(){this.$el.toggle(!1)},generateId:function(){return(new Date).getTime().toString()},listener:function(){function a(){var e=r.val();if(t.isBlank(e)){alert("Event title cannot be an empty or blank string.");return}var n={_id:t.generateId(),title:e,allDay:t.allDay,start:t.start,end:t.end,rrule:null,last_modified:new Date};t.collection.create(new s(n),{success:t.hide()}),console.log(t.collection.toJSON())}var t=this,n=e("#qtip-tooltip"),r=n.find("#tooltip-title-input").focus(),i=n.find("#tooltip-create-event"),o=n.find("#tooltip-cancel"),u=n.find("#advanced-edit");i.on("click",a),r.on("keydown",function(e){e.keyCode===13&&a()}),u.on("click",function(){var e=r.val(),n={_id:null,title:e,allDay:t.allDay,start:t.start,end:t.end,rrule:null,last_modified:null};t.calendarView.hideView(),t.eventEditorView.model=new s(n),t.eventEditorView.render(),t.hide()}),o.on("click",function(){t.hide()})}}),f=n.View.extend({el:"#dialog",initialize:function(e){this.$el.modal({backdrop:!1}),this.event=e.toJSON(),this.render(),this.show()},render:function(){var n=t.template(e("#infoDialogTemplate").html(),{event:this.event});this.$(".modal-content").html(n)},show:function(){this.$el.modal("show")}});return n.View.extend({el:"#calendar",shortcuts:{w:"weekView",d:"dayView",m:"monthView",t:"today",up:"scrollUp",down:"scrollDown",left:"nextPage",right:"prePage"},initialize:function(){t.bindAll(this,"select","unselect","loading","eventRender","eventDragStart","eventResizeStart","eventDrop","eventResize","eventClick","viewDisplay"),this.eventResizing=!1,this.elementArray=[],this.tooltip=new a,this.eventEditorView=new i,t.extend(this,new n.Shortcuts),this.delegateShortcuts(),this.render()},render:function(){var t=this;this.$el.fullCalendar({header:{left:"prev,next today title",right:"month,agendaWeek,agendaDay"},height:e(window).height()-10,timeFormat:"h:mmtt{ - h:mmtt}",editable:!0,selectable:!0,selectHelper:!0,select:this.select,slotMinutes:30,unselect:this.unselect,unselectCancel:".qtip",loading:this.loading,eventResizeStart:this.eventResizeStart,eventDragStart:this.eventDragStart,eventClick:this.eventClick,eventDrop:this.eventDrop,eventResize:this.eventResize,eventRender:this.eventRender,eventAfterAllRender:this.eventAfterAllRender,viewDisplay:this.viewDisplay}),this.tooltip.collection=this.eventEditorView.collection=this.collection,this.tooltip.calendarView=this.eventEditorView.calendarView=this,this.tooltip.eventEditorView=this.eventEditorView,e("#mini-calendar").datepicker({autoclose:!0}).on("changeDate",function(e){t.$el.fullCalendar("gotoDate",e.date),t.$el.fullCalendar("changeView","agendaDay")}),this.resizeCalendar(),this.agendaTable=e("table.fc-agenda-slots:visible").parent().parent(),this.collection.fetch({success:function(e){console.log(e.toJSON()),t.listenTo(t.collection,"add update destroy",function(e){var n=e.get("id"),r=e.get("rrule");t.$el.fullCalendar("refetchEvents")}),t.renderEvents()}}),this.on("show",this.showView),e(window).on("resize",function(){if(t.eventResizing)return;t.resizeCalendar(),t.destroyQtip(),t.$el.fullCalendar("rerenderEvents")})},weekView:function(){this.$el.fullCalendar("changeView","agendaWeek"),this.hideQtip()},dayView:function(){this.$el.fullCalendar("changeView","agendaDay"),this.hideQtip()},monthView:function(){this.$el.fullCalendar("changeView","month"),this.hideQtip()},today:function(){this.$el.fullCalendar("today")},scrollUp:function(){var t=e("table.fc-agenda-slots:visible").parent().parent();t.scrollTop(t.scrollTop()-42)},scrollDown:function(){var t=e("table.fc-agenda-slots:visible").parent().parent();t.scrollTop(t.scrollTop()+42)},nextPage:function(){this.$el.fullCalendar("next")},prePage:function(){this.$el.fullCalendar("prev")},showView:function(){this.$el.show(),this.resizeCalendar()},hideView:function(){e("#main-panel").hide()},resizeCalendar:function(){this.$el.fullCalendar("option","height",e(window).height()-10)},renderEvents:function(){var e=this,n={events:function(n,i,s){var o=[],u=[];e.collection.filter(function(e){e.get("rrule")==null?o.push(e.toJSON()):u.push(e.toJSON())});for(var a=u.length-1;a>=0;a--){var f=u[a],l=new r(f.rrule),c=l.between(n,i,!0),h=f.end?f.end.getTime()-f.start.getTime():0;for(var p=c.length-1;p>=0;p--){var d=t.clone(f);d.start=c[p],d.end=new Date(d.start.getTime()+h),e.$el.fullCalendar("renderEvent",d)}}s(o)},color:"",textColor:""};this.$el.fullCalendar("addEventSource",n)},select:function(e,t,n,r){var i=this,s=this.getPopoverFormat(e,t,n),o='<table><tbody><tr><th>Date:  </th><td id="tooltip-date">'+s.startTime+s.endTime+"</td>"+"</tr>"+"<tr>"+"<th>Title: </th>"+'<td><input id="tooltip-title-input" type="text" class="form-control"></td>'+"</tr>"+"<tr>"+'<td colspan="2">'+'<button id="tooltip-create-event" type="button" class="btn btn-xs btn-primary">Create</button>'+'<button id="tooltip-cancel" type="button" class="btn btn-xs btn-default">Cancel</button>'+'<a href="javascript:void(0)" id="advanced-edit">Advanced Edit</a>'+"</td>"+"</tr>"+"</tbody>"+"</table>";this.tooltip.set(e,t,n,o),this.tooltip.render(r)},unselect:function(){this.hideTooltip()},loading:function(e){e},eventClick:function(e){var t=this.collection.get(e._id),n=this.getPopoverFormat(e.start,e.end,e.allDay);t.set("date",n.startTime+(e.end&&n.endTime||"")),this.hideQtip(e),new f(t)},eventDrop:function(e,t,n,r,i){this.eventDropOrResize(e,i)},eventResize:function(e,t,n,r){this.eventDropOrResize(e,r),this.eventResizing=!1},eventDropOrResize:function(e,n){var r=this.collection.get(e._id),i=r.get("rrule");t.isNull(i)||(i.dtstart=e.start),this.collection.get(e._id).save({start:e.start,end:e.end,rrule:i})},eventResizeStart:function(e){this.hideQtip(e),this.eventResizing=!0},eventDragStart:function(e){this.hideQtip(e)},viewDisplay:function(){function i(){var t=new Date;if(t.getHours()==0&&t.getMinutes()<=5){var r=e(".fc-today");r.removeClass("fc-today"),r.removeClass("fc-state-highlight"),r.next().addClass("fc-today"),r.next().addClass("fc-state-highlight")}var i=e(".fc-agenda-slots:visible").parent(),s=i.children(".timeline"),o=t.getHours(),a=u().format("h:mm:ss a"),f='<span style="position:absolute;'+(o>12&&"margin-top:-23px")+'">'+a+"</span>";s.length==0&&(s=e("<div>").addClass("timeline").html(f),i.prepend(s));var l=n.fullCalendar("getView");l.visStart<t&&l.visEnd>t?s.show():s.hide();var c=t.getHours()*60*60+t.getMinutes()*60+t.getSeconds(),h=c/86400,p=Math.floor(i.height()*h);s.css({top:p+"px","padding-bottom":"10px"}).html(f);if(l.name=="agendaWeek"){var d=e(".fc-today:visible");if(d.position()!=null){var v=d.position().left+1,m=d.width();s.css({left:v+"px",width:m+"px"})}}}t.isUndefined(this.timelineInterval)||window.clearInterval(this.timelineInterval);var n=this.$el;this.timelineInterval=window.setInterval(i,1e3);try{i(this.$el)}catch(r){}},getPopoverFormat:function(t,n,r){var i=new Date(t),s=new Date(n),o="ddd, MMMM d",u="";if(n&&(!r||i.getDate()!=s.getDate())){u=" - ";if(i.getFullYear()!=s.getFullYear())u+=o+=", yyyy";else if(i.getDate()!=s.getDate()||i.getMonth()!=s.getMonth())u+=o}return r||(o+=", h(:mm)tt",u+="h(:mm)tt"),i=e.fullCalendar.formatDate(i,o),s=e.fullCalendar.formatDate(s,u),{startTime:i,endTime:s}},eventRender:function(n,r){var i=this;r.on("dblclick",function(){i.hideView(),i.eventEditorView.model=i.collection.get(n._id),i.eventEditorView.render()});var s=this.getPopoverFormat(n.start,n.end,n.allDay),o="<h3>"+n.title+"</h3>"+"<p><b>Date:</b> "+s.startTime+(n.end&&s.endTime||"")+"</p>",u=n._id+(n.rrule?"-"+n.start.getTime():"");t.isUndefined(this.elementArray[u])||this.elementArray[u].destroy(!0);var a=r.qtip({id:u,content:{title:n.title+'<div class="pull-right"><a class="qtip-edit" title="Edit" aria-label="Edit" role="button"><span class="glyphicon glyphicon-edit"></span></a><a class="qtip-delete" title="Delete" aria-label="Delete" role="button" style="margin-left: 5px"><span class="glyphicon glyphicon-trash"></span></a></div>',text:o},position:{my:"bottom center",at:"top center",viewport:e(window)},events:{render:function(t,n){var r=n.id.replace(/-.*/,"");e(this).on("click",".qtip-edit",function(){n.toggle(!1),i.hideView(),i.tooltip.hide(),i.eventEditorView.model=i.collection.get(r),i.eventEditorView.render()}),e(this).on("click",".qtip-delete",function(){confirm("Are you sure you want to delete this event?")&&i.collection.get(r).destroy({success:n.destroy(!0)})})}},hide:{fixed:!0,delay:100},style:"qtip-bootstrap"}).qtip("api");this.elementArray[u]=a},showAdvanceEditor:function(e){this.hideView(),this.eventEditorView.model=_this.collection.get(e),this.eventEditorView.render()},eventAfterAllRender:function(){},hideTooltip:function(){this.tooltip.hide()},hideQtip:function(e){for(var t=0,n=this.elementArray.length;t<n;t++)this.elementArray[t].hide()},destroyQtip:function(){var e;while(e=this.elementArray.pop())e.destroy(!0)}})});
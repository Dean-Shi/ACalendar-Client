define(["jquery","underscore","backbone","moment","rrule","bootstrap","daterangepicker","datepicker","icheck","shortcuts"],function(e,t,n,r,i){var s=function(e){var t="",n=["years","months","weeks","days"],r=["Annually","Monthly","Weekly","Daily"],s=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],o=["January","February","March","April","May","June","July","August","September","October","November","December"];e.interval===1?t+=r[e.freq]:t+="Every "+e.interval+" "+n[e.freq];if(i.WEEKLY===e.freq){t+=" on ";if(e.byweekday.length===s.length)t+="all days";else if(e.byweekday.length===0)t+="[Missing days]";else{var u=e.byweekday.length-1;for(var a=0;a<u;a++){var f=e.byweekday[a];t+=s[f]+", "}var f=e.byweekday[u];t+=s[f]}}else if(i.MONTHLY===e.freq){t+=" on day ";var l=e.dtstart;t+=l.getDate()}else if(i.YEARLY===e.freq){t+=" on ";var l=e.dtstart;t+=o[l.getMonth()]+" "+l.getDate()}return e.count?e.count===1?t="Once":t+=", "+e.count+" times":e.until&&(t+=", until "+(new Date(e.until)).toDateString()),t},o=n.View.extend({el:"#dialog",initialize:function(e){var n=this;this.editorPanel=e.editorPanel,this.rrule=e.rrule,this.dtstart=e.dtstart,this.isNewRepeat=t.isNull(this.rrule),this.isNewRepeat&&(this.rrule={freq:i.WEEKLY,interval:1,byweekday:[],dtstart:this.dtstart},this.rrule.byweekday.push(this.rrule.dtstart.getDay())),this.$el.modal({backdrop:!1})},render:function(e,n){t.isUndefined(e)||(this.rrule=e.rrule||this.rrule,this.rrule.dtstart=e.dtstart||this.rrule.dtstart),this.renderPanel(),this.registerRepeatFreq(),this.registerRepeatInterval(),this.registerRepeatOn(),this.registerRepeatEnd(),this.registerButtons(),this.showSummaryOnDialog(),!t.isUndefined(n)&&t.isFunction(n)&&n()},showSummaryOnDialog:function(){var e=s(this.rrule);this.$("#repeat-summary").html(e)},renderPanel:function(){var n=t.template(e("#repeatDialogTemplate").html(),{rrule:this.rrule,isNewRepeat:this.isNewRepeat});this.$(".modal-content").html(n)},registerRepeatFreq:function(){var t=this;t.$("#repeat-frequency").on("change",function(){t.rrule.freq=parseInt(e(this).val()),t.render()})},registerRepeatInterval:function(){var t=this;t.$("#repeat-interval").on("change",function(){t.rrule.interval=parseInt(e(this).val()),t.showSummaryOnDialog()})},registerRepeatOn:function(){var n=this;this.$("#repeat-on button").on("click",function(){e(this).toggleClass("active");var r=parseInt(this.getAttribute("data-index"));e(this).hasClass("active")?(n.rrule.byweekday.push(r),n.rrule.byweekday.sort()):(console.log(r+": "+n.rrule.byweekday.toString()),n.rrule.byweekday=t.without(n.rrule.byweekday,r),console.log(t.without(n.rrule.byweekday,r))),n.showSummaryOnDialog()})},registerRepeatEnd:function(){var t=this,n=this.$("#repeat-ends-never"),r=this.$("#repeat-ends-count"),i=this.$("#repeat-ends-count_input"),s=this.$("#repeat-ends-until"),o=this.$("#repeat-ends-until_input");e(".modal .repeat-ends-option input").iCheck({checkboxClass:"icheckbox_square-green",radioClass:"iradio_square-green",increaseArea:"20%"}),n.on("ifChecked",function(e){i.attr("disabled","disabled"),o.attr("disabled","disabled"),t.rrule.until=null,t.rrule.count=null,t.showSummaryOnDialog()}),r.on("ifChecked",function(e){i.removeAttr("disabled"),o.attr("disabled","disabled"),t.rrule.until=null,t.rrule.count=parseInt(i.val()),t.showSummaryOnDialog()}),s.on("ifChecked",function(e){o.removeAttr("disabled"),i.attr("disabled","disabled"),t.rrule.until=new Date(o.val()),t.rrule.count=null,t.showSummaryOnDialog()}),o.datepicker({autoclose:!0,startDate:t.rrule.dtstart||t.acalEvent.start}).on("changeDate",function(e){t.rrule.until=e.date,t.showSummaryOnDialog()}).on("hide",function(){hidingDatepicker=!0}),i.on("change",function(){var e=parseInt(i.val());e<=0&&(e=1,i.val(e)),t.rrule.count=e,t.showSummaryOnDialog()})},registerButtons:function(){var e=this,n=this.$("#repeat-done"),r=this.$("#repeat-close"),s=!t.isNull(this.rrule),o=t.once(function(){s=!0});n.on("click",function(){if(i.WEEKLY===e.rrule.freq&&0===e.rrule.byweekday.length){alert("Cannot add this repeating event without setting any by day.");return}o(),e.editorPanel.trigger("rruleUpdate",e.rrule),e.$el.modal("hide")}),r.on("click",function(){console.log(s),(e.isNewRepeat||!s)&&e.editorPanel.trigger("cancelRepeat")})}});return n.View.extend({el:"#editor-panel",events:{"click #event-save":"save","click #event-return":"close","click #event-delete":"delete"},shortcuts:{"shift+enter":"save",esc:"close"},initialize:function(){t.extend(this,new n.Shortcuts),this.delegateShortcuts()},render:function(){this.$el.show(),this.acalEvent=this.model,this.rrule=this.acalEvent.get("rrule"),this.dtstart=this.acalEvent.get("start"),this.isNewRepeat=t.isNull(this.rrule),this.renderEditorTemplate(this.acalEvent);var e=this,n=e.$("#repeat-dialog"),r=!1;e.registerDaterangepicker(),e.registerRepeatDialog(),e.registerCheckbox()},renderEditorTemplate:function(n){var i=n.get("start").toString(),s=n.get("end")?n.get("end").toString():i,o=r(i).format("YYYY/MM/DD h:mm A")+" - "+r(s).format("YYYY/MM/DD h:mm A"),u=r(i).format("YYYY/MM/DD")+" - "+r(s).format("YYYY/MM/DD"),a=t.template(e("#eventEditorTemplate").html(),{event:n.toJSON(),dateTimeRange:o,dateRange:u});this.$el.html(a)},registerDaterangepicker:function(){function r(t,n){e.acalEvent.set("start",new Date(t)),e.acalEvent.set("end",new Date(n))}var e=this,t=e.$("#date-time-range"),n=e.$("#date-range");t.daterangepicker({timePicker:!0,timePickerIncrement:30,format:"YYYY/MM/DD h:mm A"},function(e,t){n.val(e.format("YYYY/MM/DD")+" - "+t.format("YYYY/MM/DD")),r(e,t)}),n.daterangepicker({format:"YYYY/MM/DD"},function(e,n){t.val(e.format("YYYY/MM/DD h:mm A")+" - "+n.format("YYYY/MM/DD h:mm A")),r(e,n)})},registerCheckbox:function(){function l(e){var t=e,n=t.next(),r=n.text();n.remove(),t.iCheck({checkboxClass:"icheckbox_line-blue",radioClass:"iradio_line-blue",insert:'<div class="icheck_line-icon"></div>'+r})}var e=this,n=this.acalEvent.get("rrule"),r=!t.isNull(n),i=this.$("#event-repeat-summary-area"),s=this.$("#event-repeat-edit"),o=e.$("#date-time-range"),u=e.$("#date-range"),a=this.$("#check-allday"),f=this.$("#check-repeat");l(a),l(f);var c=t.once(function(){s.on("click",function(){e.isNewRepeat||e.repeatDialog.render({dtstart:e.acalEvent.get("start")}),e.repeatDialog.$el.modal("show"),console.log(e.rrule)})}),h=t.once(function(){r=!0});a.on("ifToggled",function(){u.toggle(),o.toggle(),e.acalEvent.set("allDay",!e.acalEvent.get("allDay"))}),f.on("ifChecked",function(t){r?i.show():(e.isNewRepeat&&e.repeatDialog.render({dtstart:e.acalEvent.get("start")}),e.repeatDialog.$el.modal("show")),e.rrule=n}),f.on("ifUnchecked",function(t){i.hide(),e.rrule=null}),r&&(this.showSummaryOnPanel(n),f.iCheck("check"),c()),this.listenTo(this,"rruleUpdate",function(t){h(),console.log(r),e.rrule=n=t,e.showSummaryOnPanel(n),i.show(),c()}),this.listenTo(this,"cancelRepeat",function(){f.iCheck("uncheck")})},registerRepeatDialog:function(){this.repeatDialog=new o({editorPanel:this,rrule:this.rrule,dtstart:this.dtstart})},showSummaryOnPanel:function(e){var t=s(e);this.$("#event-repeat-summary-text").html(t)},generateId:function(){return(new Date).getTime().toString()},isBlank:function(e){return/^\s*$/.test(e)},close:function(){e("#main-panel").show(),this.calendarView.trigger("show"),this.$el.hide(),e(".daterangepicker").remove(),e(".modal-body table").children().remove()},save:function(){var e=this.$("#event-title-input").val(),n=this.$("#event-location-input").val(),r=this.$("#event-description-input").val();if(e===""&&!confirm("Are you sure you want to save this event without title?"))return;t.isNull(this.rrule)||(this.rrule.dtstart=this.acalEvent.get("start")),this.acalEvent.set({title:e||"Untitled Event",allDay:this.acalEvent.get("allDay"),start:this.acalEvent.get("start"),end:this.acalEvent.get("end"),rrule:this.rrule,last_modified:new Date,location:this.isBlank(n)?null:n,description:this.isBlank(r)?null:r}),this.acalEvent.isNew()?(this.acalEvent.set({_id:this.generateId()}),this.collection.create(this.acalEvent,{success:this.close()})):(this.acalEvent.save({},{success:this.close()}),this.collection.trigger("update",this.acalEvent))},"delete":function(){confirm("Are you sure you want to delete this event?")&&this.acalEvent.destroy({success:this.close()})}})});
define(["jquery","underscore","backbone","moment","rrule","bootstrap","daterangepicker","datepicker","icheck"],function(e,t,n,r,i){var s=function(e){var t="",n=["years","months","weeks","days"],r=["Annually","Monthly","Weekly","Daily"],s=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],o=["January","February","March","April","May","June","July","August","September","October","November","December"];e.interval===1?t+=r[e.freq]:t+="Every "+e.interval+" "+n[e.freq];if(i.WEEKLY===e.freq){t+=" on ";if(e.byweekday.length===s.length)t+="all days ";else for(var u=0;u<e.byweekday.length;u++){var a=e.byweekday[u];t+=s[a],u!=e.byweekday.length-1&&(t+=", ")}}else if(i.MONTHLY===e.freq){t+=" on day ";var f=e.dtstart;t+=f.getDate()}else if(i.YEARLY===e.freq){t+=" on ";var f=e.dtstart;t+=o[f.getMonth()]+" "+f.getDate()}return e.count?e.count===1?t="Once":t+=", "+e.count+" times":e.until&&(t+=", until "+(new Date(e.until)).toDateString()),t},o=n.View.extend({el:"#repeat-dialog",initialize:function(e){var n=this,r=this.$("#repeat-done"),s=this.$("#repeat-close"),o=this.$("#repeat-by"),u=this.$("#repeat-on");this.editorPanel=e.editorPanel,this.rrule=e.rrule,this.start=e.start;var a=!t.isNull(this.rrule),f=t.once(function(){a=!0});this.$el.modal({backdrop:!1}),a||(this.rrule={freq:i.WEEKLY,interval:1,byweekday:[],dtstart:this.start},this.rrule.byweekday.push(this.rrule.dtstart.getDay())),this.renderPanel(),r.on("click",function(){if(i.WEEKLY===n.rrule.freq&&0===n.rrule.byweekday.length){alert("Cannot add this repeating event without setting any by day.");return}f(),n.$el.modal("hide"),n.editorPanel.trigger("rruleUpdate",n.rrule)}),s.on("click",function(){a||n.editorPanel.trigger("cancelRepeat")})},render:function(){this.registerRepeatFreq(),this.registerRepeatInterval(),this.registerRepeatOn(),this.registerRepeatEnd(),this.showSummaryOnDialog()},showSummaryOnDialog:function(){var e=s(this.rrule);this.$("#repeat-summary").html(e)},renderPanel:function(){var n=t.template(e("#repeatDialogTemplate").html(),{rrule:this.rrule});this.$(".modal-body table").html(n)},registerRepeatFreq:function(){var t=this;t.$("#repeat-frequency").on("change",function(){t.rrule.freq=parseInt(e(this).val()),t.renderPanel(),t.render()})},registerRepeatInterval:function(){var t=this;t.$("#repeat-interval").on("change",function(){t.rrule.interval=parseInt(e(this).val()),t.showSummaryOnDialog()})},registerRepeatOn:function(){var n=this;e("#repeat-on input[type=checkbox]").each(function(){var r=["SU","MO","TU","WE","TH","FR","SA"];e(this).change(function(){if(this.checked)n.rrule.byweekday.push(t.indexOf(r,this.name)),n.rrule.byweekday.sort();else{var e=t.indexOf(r,this.name);n.rrule.byweekday=t.without(n.rrule.byweekday,e)}n.showSummaryOnDialog()})})},registerRepeatEnd:function(){var t=this,n=this.$("#repeat-ends-never"),r=this.$("#repeat-ends-count"),i=this.$("#repeat-ends-count_input"),s=this.$("#repeat-ends-until"),o=this.$("#repeat-ends-until_input");e(".modal .repeat-ends-option input").iCheck({checkboxClass:"icheckbox_square-green",radioClass:"iradio_square-green",increaseArea:"20%"}),n.on("ifChecked",function(e){i.attr("disabled","disabled"),o.attr("disabled","disabled"),t.rrule.until=null,t.rrule.count=null,t.showSummaryOnDialog()}),r.on("ifChecked",function(e){i.removeAttr("disabled"),o.attr("disabled","disabled"),t.rrule.until=null,t.rrule.count=parseInt(i.val()),t.showSummaryOnDialog()}),s.on("ifChecked",function(e){o.removeAttr("disabled"),i.attr("disabled","disabled"),t.rrule.until=new Date(o.val()),t.rrule.count=null,t.showSummaryOnDialog()}),o.datepicker({autoclose:!0,startDate:t.rrule.dtstart||t.acalEvent.start}).on("changeDate",function(e){t.rrule.until=e.date,console.log(t.rrule.until)}).on("hide",function(){hidingDatepicker=!0})}});return n.View.extend({el:"#editor-panel",events:{"click #event-save":"save","click #event-return":"close","click #event-delete":"delete"},initialize:function(){},render:function(){this.$el.show(),this.acalEvent=this.model,this.rrule=this.acalEvent.get("rrule"),this.start=this.acalEvent.get("start"),this.repeatDialog=new o({editorPanel:this,rrule:this.rrule,start:this.start}),this.renderEditorTemplate(this.acalEvent);var e=this,t=e.$("#repeat-dialog"),n=!1;e.registerDaterangepicker(),e.registerCheckbox(),e.registerRepeatDialog()},renderEditorTemplate:function(n){var i=n.get("start").toString(),s=n.get("end")?n.get("end").toString():i,o=r(i).format("YYYY/MM/DD h:mm A")+" - "+r(s).format("YYYY/MM/DD h:mm A"),u=r(i).format("YYYY/MM/DD")+" - "+r(s).format("YYYY/MM/DD"),a=t.template(e("#eventEditorTemplate").html(),{event:n.toJSON(),dateTimeRange:o,dateRange:u});this.$el.html(a)},registerDaterangepicker:function(){function r(t,n){e.acalEvent.set("start",new Date(t)),e.acalEvent.set("end",new Date(n))}var e=this,t=e.$("#date-time-range"),n=e.$("#date-range");t.daterangepicker({timePicker:!0,timePickerIncrement:30,format:"YYYY/MM/DD h:mm A"},function(e,t){n.val(e.format("YYYY/MM/DD")+" - "+t.format("YYYY/MM/DD")),r(e,t)}),n.daterangepicker({format:"YYYY/MM/DD"},function(e,n){t.val(e.format("YYYY/MM/DD h:mm A")+" - "+n.format("YYYY/MM/DD h:mm A")),r(e,n)})},registerCheckbox:function(){function l(e){var t=e,n=t.next(),r=n.text();n.remove(),t.iCheck({checkboxClass:"icheckbox_line-blue",radioClass:"iradio_line-blue",insert:'<div class="icheck_line-icon"></div>'+r})}var e=this,n=this.acalEvent.get("rrule"),r=!t.isNull(n),i=this.$("#event-repeat-summary-area"),s=this.$("#event-repeat-edit"),o=e.$("#date-time-range"),u=e.$("#date-range"),a=this.$("#check-allday"),f=this.$("#check-repeat");l(a),l(f);var c=t.once(function(){s.on("click",function(){e.repeatDialog.$el.modal("show"),console.log(e.repeatDialog)})});a.on("ifToggled",function(){u.toggle(),o.toggle(),e.acalEvent.set("allDay",!e.acalEvent.get("allDay"))}),f.on("ifChecked",function(t){r?i.show():e.repeatDialog.$el.modal("show"),e.rrule=n}),f.on("ifUnchecked",function(t){i.hide(),e.rrule=null}),r&&(this.showSummaryOnPanel(n),f.iCheck("check"),c()),this.listenTo(this,"rruleUpdate",function(t){e.rrule=n=t,e.showSummaryOnPanel(n),i.show(),c()}),this.listenTo(this,"cancelRepeat",function(){f.iCheck("uncheck")})},registerRepeatDialog:function(){this.repeatDialog.render()},showSummaryOnPanel:function(e){var t=s(e);this.$("#event-repeat-summary-text").html(t)},generateId:function(){return(new Date).getTime().toString()},close:function(){this.calendarView.trigger("show"),this.$el.hide(),e(".daterangepicker").remove(),e(".modal-body table").children().remove()},save:function(){if(this.$("#event-title-input").val()===""&&!confirm("Are you sure you want to save this event without title?"))return;console.log(this.rrule),t.isNull(this.rrule)||(this.rrule.dtstart=this.acalEvent.get("start")),this.acalEvent.set({title:this.$("#event-title-input").val()||"Untitled Event",allDay:this.acalEvent.get("allDay"),start:this.acalEvent.get("start"),end:this.acalEvent.get("end"),rrule:this.rrule,last_modified:new Date}),this.acalEvent.isNew()?(this.acalEvent.set({_id:this.generateId()}),this.collection.create(this.acalEvent,{success:this.close()})):(this.collection.get(this.acalEvent.get("_id")).save(this.acalEvent.toJSON(),{success:this.close()}),console.log(this.collection))},"delete":function(){confirm("Are you sure you want to delete this event?")&&this.acalEvent.destroy({success:this.close()})}})});
var bongo;!function(e){var t=function(){function t(t,n){"undefined"==typeof n&&(n=function(){}),this.ensured=!1,this.objectStores=[];var r,i,t,s;if(t.objectStores=t.objectStores||t.collections||[],this.name=t.name,t.objectStores instanceof Array)for(var o=0;o<t.objectStores.length;o++)"string"==typeof t.objectStores[o]&&(t.objectStores[o]={name:t.objectStores[o]}),i=new e.ObjectStore(this,t.objectStores[o]),this[i.name]=i,this.objectStores.push(i);else for(r in t.objectStores)t.objectStores[r]instanceof Array&&(s={},t.objectStores[r].forEach(function(e){s[e]={keyPath:e,multiEntry:!1,unique:!1}}),t.objectStores[r]={name:r,indexes:s}),i=new e.ObjectStore(this,t.objectStores[r]),this[i.name]=i,this.objectStores.push(i);e.supported&&this.ensure(n)}return t.prototype.collection=function(e){return this.objectStore(e)},t.prototype.objectStore=function(t){if("undefined"==typeof this[t]){console.log("name",t);var n=new e.ObjectStore(this,t);return this[n.name]=n,this.objectStores.push(n),this.ensured=!1,this.ensure(),n}return this[t]},t.prototype.signature=function(){var e={};return this.objectStores.forEach(function(t){e[t.name]={autoIncrement:t.autoIncrement,indexes:t.indexes,keyPath:t.keyPath,name:t.name}}),{name:this.name,objectStores:e}},t.prototype.delete=function(t){"undefined"==typeof t&&(t=function(){});for(var n=this,r=0,i=0;i<this.objectStores.length;i++)delete this[this.objectStores[i].name];delete this.objectStores;var s=function(){var i=e.indexedDB.deleteDatabase(n.name);i.onsuccess=function(){t()}.bind(n),i.onblocked=function(){if(!(40>r))throw i.webkitErrorMessage||i.error.name;setTimeout(function(){s(),r++},250)}.bind(n),i.onerror=function(){throw i.webkitErrorMessage||i.error.name}.bind(n)};this.get(function(e){e.close(),s()})},t.prototype.get=function(t){var n=this,r=500,i=function(){if(!n.ensured)return e.debug&&console.log("Database not ensured yet"),r--,r>0&&setTimeout(function(){i()},200),void 0;e.debug&&console.log("Database is ensured");var s=e.indexedDB.open(n.name);s.onupgradeneeded=function(){e.debug&&console.debug("onupgradeneeded"),s.result},s.onsuccess=function(n){e.debug&&console.debug("onsuccess"),t(n.target.result)},s.onblocked=function(){throw console.log(n.version,s),console.log("onblocked"),s.webkitErrorMessage||s.error.name},s.onerror=function(){throw console.log("onerror"),s.webkitErrorMessage||s.error.name},s.onfailure=s.onerror};i()},t.prototype.ensure=function(t){"undefined"==typeof t&&(t=function(){});var n=this;e.debug&&console.debug("Ensuring "+this.name),e.getStoredSignature(this.name,function(r){return e.debug&&console.debug("Signature found: "+JSON.stringify(r)),e.equals(r,n.signature())?(e.getStoredVersion(n.name,function(e){n.version=e,t()}),n.ensured=!0,void 0):(e.getStoredVersion(n.name,function(i){e.debug&&console.debug("Version found: "+i),n.version=i+1;var s=e.indexedDB.open(n.name,n.version);s.onblocked=function(){console.log("blocked",s.error.name)},s.onupgradeneeded=function(i){e.debug&&console.debug("onupgradeneeded in ensure, version "+n.version);for(var o=i.currentTarget.transaction,u=s.result,l=0;l<n.objectStores.length;l++)n.objectStores[l].ensureObjectStore(o,r,u);for(var h in r.objectStores)"undefined"==typeof n[h]&&u.objectStoreNames.contains(h)&&u.deleteObjectStore(h);n.version>2&&u.close(),setTimeout(function(){t()},1),n.ensured=!0}}),void 0)})},t}();e.Database=t}(bongo||(bongo={}));var bongo;!function(e){function t(){var e=Math.floor((new Date).valueOf()/1e3).toString(16);this.key_m||(this.key_m=Math.floor(16777216*Math.random()).toString(16)),this.key_p||(this.key_p=Math.floor(32767*Math.random()).toString(16)),"undefined"==typeof this.key_i?this.key_i=0:this.key_i>16777215&&(this.key_i=0),this.key_i=Number(this.key_i),this.key_i++;var t=this.key_i.toString(16),n="00000000".substr(0,6-e.length)+e+"000000".substr(0,6-this.key_m.length)+this.key_m+"0000".substr(0,4-this.key_p.length)+this.key_p+"000000".substr(0,6-t.length)+t;return n}var n=function(){function t(e,t){this.database=e,this.name=t.name,this.keyPath=t.keyPath||"_id",this.autoIncrement=!!t.autoIncrement,this.indexes=t.indexes||{}}return t.prototype.filter=function(t){var n=new e.Query(this.database,[this.name]);return n.filter(t)},t.prototype.find=function(t,n){"undefined"==typeof n&&(n=null);var r=new e.Query(this.database,[this.name]);return r.find(t,n)},t.prototype.findOne=function(t,n){var r=new e.Query(this.database,[this.name]);return r.findOne(t,n)},t.prototype.count=function(e,t){var n=this;"undefined"==typeof t&&"function"==typeof e&&(t=[e,e=null][0]);var r,i=function(e){t(e.target.result)};this.database.get(function(e){var t=e.transaction([n.name],"readonly"),s=t.objectStore(n.name);r=s.count(),r.onsuccess=i}.bind(this))},t.prototype.ensureObjectStore=function(t,n,r){var t,i,s=null;e.debug&&console.debug("ensureObjectStore"),r.objectStoreNames&&r.objectStoreNames.contains(this.name)?r.objectStoreNames&&r.objectStoreNames.contains(this.name)&&(i=t.objectStore(this.name)):(e.debug&&console.debug("Creating "+this.name),i=r.createObjectStore(this.name,{keyPath:"_id",autoIncrement:!1}));for(var o=0;o<i.indexNames.length;o++)"undefined"==typeof this.indexes[i.indexNames.item(o)]&&(console.log("deleting"),i.deleteIndex(i.indexNames.item(o)));for(var s in this.indexes)i.indexNames.contains(s)||i.createIndex(s,this.indexes[s].keyPath);return i},t.prototype.get=function(e,t){"undefined"==typeof e&&(e=""),"undefined"==typeof t&&(t=function(){});var n=this;this.database.get(function(r){var i=r.transaction([n.name],"readonly"),s=i.objectStore(n.name),o=s.get(e);o.onsuccess=function(e){t(e.target.error,e.target.result)}}.bind(this))},t.prototype.remove=function(e,t){"undefined"==typeof t&&(t=function(){});var n=this;this.database.get(function(r){var i,s=r.transaction([n.name],"readwrite"),o=s.objectStore(n.name);"string"==typeof e?i=o.delete(e):("undefined"==typeof e||"{}"===JSON.stringify(e))&&(i=o.clear()),i.onsuccess=function(e){t(e.target.error,e.target.result)}},!0)},t.prototype.save=function(t,n){"undefined"==typeof n&&(n=function(){});var r=this;t._id||(t._id=e.key()),this.database.get(function(e){var i=e.transaction(r.name,"readwrite"),s=i.objectStore(r.name),o=s.put(t);o.onsuccess=function(e){n(e.target.error,e.target.result)}},!0)},t.prototype.insert=function(t,n){"undefined"==typeof n&&(n=function(){});var r=this;t._id||(t._id=e.key()),this.database.get(function(e){var i=e.transaction([r.name],"readwrite"),s=i.objectStore(r.name),o=s.add(t);o.onerror=function(e){console.log(e.target.error)},o.onsuccess=function(e){n(e.target.error,e.target.result)}},!0)},t.prototype.oldFind=function(t,n){var r=this,i=t.criteria||{},s=t.skip||0;this.database.get(function(o){var u=o.transaction([r.name],"readonly"),l=u.objectStore(r.name),h=[];t.sort&&(h=Object.keys(t.sort));var p=Object.keys(i);"boolean"==typeof i[p[0]]&&(i[p[0]]=i[p[0]]?1:0);var v,m,g,y=[];return 1===p.length&&l.indexNames&&l.indexNames.contains(p[0])?(g=function(e){if(e.target.error)return n(e.target.error);var r=e.target.result;return s>0?s--:r&&y.push(r.value),r&&(!t.limit||y.length<t.limit)?(r["continue"](),void 0):(n(null,y),void 0)},m=l.index(p[0]),v=e.IDBKeyRange.only(i[p[0]]),m.openCursor(v).onsuccess=g,void 0):(g=function(e){if(e.target.error)return n(e.target.error);var r=e.target.result;if(!r)return n(null,y),void 0;if(p.length){var o,u=!0;for(o in p)("undefined"==typeof r.value[p[o]]||r.value[p[o]]!==i[p[o]])&&(u=!1);u&&y.push(r.value)}else s>0?s--:r&&y.push(r.value);return!t.limit||y.length<t.limit?(r["continue"](),void 0):(n(null,y),void 0)},t.sort&&l.indexNames.contains(h[0])?(m=l.index(h[0]),1===t.sort[h[0]]?m.openCursor().onsuccess=g:m.openCursor(null,"prev").onsuccess=g,void 0):(l.openCursor().onsuccess=g,void 0))})},t}();e.ObjectStore=n,e.key=t}(bongo||(bongo={}));var bongo;!function(e){function t(e,t){for(var n={},r=0;r<t.length;r++)t[r]in e&&(n[t[r]]=e[t[r]]);return n}var n=function(){function n(e,t){this.database=e,this.objectStores=t,this._limit=100,this._skip=0,this.from=null,this.to=null,this.before=null,this.after=null,this.filters=[],this.keys=[]}return n.prototype.findOne=function(t,n){return e.supported?(this.find(t).limit(1).toArray(function(e,t){return e?n(e):(t.length?n(e,t[0]):n(e,null),void 0)}),void 0):n("IndexedDB not supported")},n.prototype.find=function(e,t){"undefined"==typeof e&&(e={}),"undefined"==typeof t&&(t=null);var n;if(t&&"object"==typeof t){var r=[];for(n in t)t[n]&&r.push(n);this.pick(r)}return this.filters.push(function(t){var n,r;for(var i in e)if(e[i].constructor===Object)for(n in e[i]){if("$nin"!==n&&"undefined"==typeof t[i])return!1;if("$gt"===n){if(t[i]<=e[i][n])return!1}else if("$gte"===n){if(t[i]<e[i][n])return!1}else if("$lt"===n){if(t[i]>=e[i][n])return!1}else if("$lte"===n){if(t[i]>e[i][n])return!1}else if("$ne"===n){if(t[i]==e[i][n])return!1}else if("$in"===n&&e[i][n]instanceof Array){if(-1===e[i][n].indexOf(t[i]))return!1}else if("$nin"===n&&e[i][n]instanceof Array){if(-1!==e[i][n].indexOf(t[i]))return!1}else{if(!("$all"===n&&t[i]instanceof Array&&e[i][n]instanceof Array))return!1;for(r=0;r<e[i][n].length;r++)if(-1===t[i].indexOf(e[i][n][r]))return!1}}else{if("undefined"==typeof t[i])return!1;if("string"==typeof e[i]||"number"==typeof e[i]){if(t[i]!=e[i])return!1}else if("object"==typeof e[i]&&e[i]instanceof RegExp&&!e[i].test(t[i]))return!1}return!0}),this},n.prototype.filter=function(e){return this.filters.push(e),this},n.prototype.skip=function(e){return this._skip=e,this},n.prototype.limit=function(e){return this._limit=e,this},n.prototype.pick=function(e){return this.keys=e,this},n.prototype.toArray=function(n){var r=this;return e.supported?(this.database.get(function(e){var i=e.transaction(r.objectStores,"readonly"),s=i.objectStore(r.objectStores[0]),o=[],u=function(i){if(i.target.error)return e.close(),n(i.target.error);var s,u,f=i.target.result;if(!f)return e.close(),n(null,o),void 0;if(s=f.value,r.filters.length){u=!0;for(var l=0;l<r.filters.length;l++)r.filters[l](f.value)||(u=!1);u&&(r._skip>0?r._skip--:(r.keys.length&&(s=t(s,r.keys)),o.push(s)))}else r._skip>0?r._skip--:(r.keys.length&&(s=t(s,r.keys)),o.push(s));return o.length<r._limit?(f.continue(),void 0):(e.close(),n(null,o),void 0)};s.openCursor().onsuccess=u}),void 0):n("IndexedDB not supported")},n}();e.Query=n}(bongo||(bongo={}));var bongo;!function(e){function t(t,n){if("undefined"==typeof n&&(n=function(){}),"string"==typeof t){if("undefined"!=typeof e[t])return e[t];t={name:t}}return"undefined"==typeof e[t.name]&&Object.defineProperty(e,t.name,{value:new e.Database(t,n)}),e[t.name]}function n(t,n){"undefined"==typeof n&&(n=function(e){console.log(e)});var r=e.indexedDB.open(t);r.onsuccess=function(e){var t=e.target.result;t.close(),n(t.version)}}function r(t,n){"undefined"==typeof n&&(n=function(e){console.log(e)});var r=e.indexedDB.open(t);r.onblocked=function(e){console.log("blocked",e)},r.onsuccess=function(e){var t,r,i,s=e.target.result,o=[],u={};for(t=0;t<s.objectStoreNames.length;t++)o.push(s.objectStoreNames.item(t));if(!o.length)return s.close(i),n({name:s.name,objectStores:u});var a=s.transaction(o,"readonly");o.forEach(function(e){var t,n=a.objectStore(e);r={};for(var i=0;i<n.indexNames.length;i++)t=n.index(n.indexNames.item(i)),r[n.indexNames.item(i)]={keyPath:t.keyPath,multiEntry:t.multiEntry,unique:t.unique};u[e]={autoIncrement:n.autoIncrement,indexes:r,keyPath:n.keyPath,name:n.name}}),a.oncomplete=function(){return s.close(i),n({name:s.name,objectStores:u})}}}function i(e,t){var n;if(e===t)return!0;for(n in e)if("undefined"==typeof t[n])return!1;for(n in t)if("undefined"==typeof e[n])return!1;if(typeof e!=typeof t)return!1;if("object"!=typeof e)return e===t;for(n in e)if(e[n]){if("object"==typeof e[n]){if(!i(e[n],t[n]))return!1}else if(e[n]!==t[n])return!1}else if(t[n])return!1;return!0}function s(t){"undefined"==typeof t&&(t=null),console.group("Bongo");var n,r=function(t){var n=e.indexedDB.open(t);n.onsuccess=function(e){for(var t=e.target.result,n=[],r=0;r<t.objectStoreNames.length;r++)n.push(t.objectStoreNames.item(r));console.log({name:t.name,objectStores:n,version:t.version})}};t?r(t):e.indexedDB.webkitGetDatabaseNames&&(n=e.indexedDB.webkitGetDatabaseNames(),n.onsuccess=function(e){for(var t=e.target.result,n=0;n<t.length;n++)r(t.item(n))}),console.groupEnd()}e.debug=!1,e.indexedDB=window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB,e.IDBTransaction=window.IDBTransaction||window.webkitIDBTransaction||window.msIDBTransaction,e.IDBKeyRange=window.IDBKeyRange||window.webkitIDBKeyRange||window.msIDBKeyRange,e.supported=!!e.indexedDB&&!!e.IDBTransaction&&!!e.IDBKeyRange,e.db=t,e.getStoredVersion=n,e.getStoredSignature=r,e.equals=i,e.info=s}(bongo||(bongo={})),"object"==typeof module&&"object"==typeof module.exports?module.exports=bongo:"function"==typeof define&&define.amd&&define("bongo",[],function(){return bongo});